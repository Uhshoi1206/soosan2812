---
import BlogLayout from '../../../layouts/BlogLayout.astro';
import Layout from '../../../components/Layout.tsx';
import { getCollection, getEntry } from 'astro:content';
import { getBlogCategories } from '../../../utils/blogCategories';
import { getVisibleBlogPosts } from '../../../utils/contentCollections';
import { OptimizedImage } from '../../../components/ui/optimized-image.tsx';
import BlogSidebar from '../../../components/blog/BlogSidebar.tsx';
import TableOfContents from '../../../components/blog/TableOfContents.tsx';
import '../../../components/blog/BlogStyles.css';
import { getVisibleProducts } from '../../../utils/contentCollections';
import type { Truck } from '../../../models/TruckTypes';
import { getVehicleUrlPrefix } from '../../../models/TruckTypes';
import useRelatedTruckForBlogPost from '../../../hooks/useRelatedTruckForBlogPost';

export const prerender = true;

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const { getCategorySlug } = await getBlogCategories();

  return allPosts
    .filter(post => !post.data.isHidden)
    .map((post) => {
      // Extract slug: prefer frontmatter slug, then extract filename from post.id (which may include folder path)
      let slug = post.data.slug;
      if (!slug) {
        // post.id can be like "buying-guide/post-name" or just "post-name"
        // We need just the final part (filename without extension)
        const idWithoutExtension = post.id.replace(/\.md$/, '');
        slug = idWithoutExtension.includes('/') 
          ? idWithoutExtension.split('/').pop()! 
          : idWithoutExtension;
      }
      return {
        params: {
          categorySlug: getCategorySlug(post.data.category),
          postSlug: slug
        },
        props: { post },
      };
    });
}

const { post } = Astro.props;
const { Content } = await post.render();
const postData = post.data;
const { categories, categoryMap, categoryInfoMap, getCategorySlug } = await getBlogCategories();
const categoryLabel = categoryMap[postData.category] || postData.category;
const categorySlug = getCategorySlug(postData.category);

const allPosts = await getVisibleBlogPosts();
// Extract slug, handling nested folder paths in post.id
let currentSlug = postData.slug;
if (!currentSlug) {
  const idWithoutExtension = post.id.replace(/\.md$/, '');
  currentSlug = idWithoutExtension.includes('/') 
    ? idWithoutExtension.split('/').pop()! 
    : idWithoutExtension;
}

const relatedPosts = allPosts
  .filter(p => {
    return p.category === postData.category && p.slug !== currentSlug;
  })
  .slice(0, 3);

const recommendedPosts = allPosts
  .filter(p => p.category === postData.category && p.slug !== currentSlug)
  .slice(0, 4)
  .map(p => ({
    ...p,
    url: `/danh-muc-bai-viet/${getCategorySlug(p.category)}/${p.slug}`
  }));

const allProducts = await getVisibleProducts();

const blogPostForMatching = {
  ...postData,
  content: post.body,
  id: post.id
};

const relatedProduct = useRelatedTruckForBlogPost(blogPostForMatching, allProducts);
const relatedProducts = relatedProduct ? [relatedProduct] : [];

const getPostUrl = (post: any) => {
  const catSlug = getCategorySlug(post.category);
  return `/danh-muc-bai-viet/${catSlug}/${post.slug}`;
};

const tags = postData.tags || [];

// Prepare article data for BlogLayout
const articleForSchema = {
  id: post.id,
  title: postData.title,
  slug: currentSlug,
  description: postData.description,
  category: postData.category,
  images: postData.images,
  publishDate: postData.publishDate,
  readTime: postData.readTime,
  author: postData.author || 'Trần Tú',
  tags: postData.tags,
  views: postData.views,
  comments: postData.comments
};

const settingsEntry = await getEntry('settings', 'site-settings');
const settings = settingsEntry?.data;
---

<BlogLayout 
  article={articleForSchema} 
  categoryName={categoryLabel} 
  categorySlug={categorySlug}
  content={post.body}
>
  <Layout client:load siteSettings={settings}>
    <article class="bg-gray-50 py-8">
      <div class="container mx-auto px-4">
        <nav class="text-sm text-gray-600 mb-6">
          <a href="/" class="hover:text-primary">Trang chủ</a>
          <span class="mx-2">›</span>
          <a href="/danh-muc-bai-viet" class="hover:text-primary">Blog</a>
          <span class="mx-2">›</span>
          <a href={`/danh-muc-bai-viet/${categorySlug}`} class="hover:text-primary">{categoryLabel}</a>
          <span class="mx-2">›</span>
          <span class="text-gray-900">{postData.title}</span>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
          <div class="lg:col-span-8">
            <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
              <div class="mb-6">
                <a
                  href={`/danh-muc-bai-viet/${categorySlug}`}
                  class="inline-block bg-primary/10 text-primary px-4 py-1 rounded-full text-sm font-medium hover:bg-primary/20 transition mb-4"
                >
                  {categoryLabel}
                </a>

                <h1 class="text-3xl md:text-4xl font-bold mb-4 text-gray-900">
                  {postData.title}
                </h1>

                <div class="flex items-center gap-4 text-sm text-gray-600 mb-6">
                  <div class="flex items-center gap-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span>{postData.author || 'Trần Tú'}</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <time datetime={postData.publishDate}>
                      {new Date(postData.publishDate).toLocaleDateString('vi-VN')}
                    </time>
                  </div>
                  <div class="flex items-center gap-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>{postData.readTime} phút đọc</span>
                  </div>
                </div>
              </div>

              {postData.images && postData.images[0] && (
                <div class="mb-8 rounded-lg overflow-hidden">
                  <OptimizedImage
                    client:load
                    src={postData.images[0]}
                    alt={postData.title}
                    className="w-full h-auto"
                    useCase="gallery"
                  />
                </div>
              )}

              <div class="prose prose-lg max-w-none prose-content" set:html={post.body}>
              </div>

              {tags.length > 0 && (
                <div class="mt-8 pt-8 border-t border-gray-200">
                  <div class="flex flex-wrap gap-2">
                    {tags.map((tag: string) => (
                      <span key={tag} class="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">
                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        {tag}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600">Chia sẻ bài viết:</span>
                  <div class="flex items-center gap-2">
                    <button class="p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition">
                      <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                      </svg>
                    </button>
                    <button class="p-2 rounded-full bg-blue-400 text-white hover:bg-blue-500 transition">
                      <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                      </svg>
                    </button>
                    <button class="p-2 rounded-full bg-gray-700 text-white hover:bg-gray-800 transition">
                      <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/>
                      </svg>
                    </button>
                    <button class="p-2 rounded-full bg-gray-600 text-white hover:bg-gray-700 transition">
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {relatedProducts.length > 0 && (
              <div class="bg-white rounded-lg shadow-sm p-8 mb-6">
                <h2 class="text-2xl font-bold mb-6">Sản phẩm đề xuất từ bài viết</h2>
                {relatedProducts.map((product: Truck) => (
                  <div key={product.slug} class="border border-gray-200 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                      <div class="md:col-span-1">
                        {product.images && product.images[0] && (
                          <OptimizedImage
                            client:load
                            src={product.images[0]}
                            alt={product.name}
                            className="w-full h-auto rounded-lg"
                            useCase="thumbnail"
                          />
                        )}
                      </div>
                      <div class="md:col-span-2">
                        <h3 class="text-xl font-bold mb-2">{product.name}</h3>
                        <p class="text-2xl font-bold text-primary mb-4">
                          {product.price ? `${product.price.toLocaleString('vi-VN')} VNĐ` : 'Liên hệ'}
                        </p>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                          <div>
                            <span class="text-gray-600">Thương hiệu:</span>
                            <span class="font-medium ml-2">{product.brand}</span>
                          </div>
                          {product.specifications?.payload && (
                            <div>
                              <span class="text-gray-600">Tải trọng:</span>
                              <span class="font-medium ml-2">{product.specifications.payload}</span>
                            </div>
                          )}
                        </div>
                        <a href={`/${getVehicleUrlPrefix(product.type)}/${product.slug}`} class="inline-block bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition">
                          Xem chi tiết
                        </a>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {relatedPosts.length > 0 && (
              <div class="bg-white rounded-lg shadow-sm p-8">
                <h2 class="text-2xl font-bold mb-6">Bài viết liên quan</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  {relatedPosts.map((relatedPost) => (
                    <a
                      key={relatedPost.slug}
                      href={getPostUrl(relatedPost)}
                      class="group"
                    >
                      <article class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition">
                        {relatedPost.images && relatedPost.images[0] && (
                          <OptimizedImage
                            client:load
                            src={relatedPost.images[0]}
                            alt={relatedPost.title}
                            className="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"
                            useCase="thumbnail"
                          />
                        )}
                        <div class="p-4">
                          <h3 class="font-bold mb-2 group-hover:text-primary transition line-clamp-2">
                            {relatedPost.title}
                          </h3>
                          <div class="flex items-center gap-3 text-xs text-gray-500">
                            <span>{new Date(relatedPost.publishDate).toLocaleDateString('vi-VN')}</span>
                            <span>{relatedPost.readTime} phút đọc</span>
                          </div>
                        </div>
                      </article>
                    </a>
                  ))}
                </div>
              </div>
            )}
          </div>

          <aside class="lg:col-span-4">
            <div class="sticky top-8">
              <BlogSidebar
                client:only="react"
                categories={categoryMap}
                categoryInfoMap={categoryInfoMap}
                currentCategory={postData.category}
                recommendedPosts={recommendedPosts}
              />
            </div>
          </aside>
        </div>
      </div>
    </article>
    <TableOfContents client:only="react" content={post.body} />
  </Layout>
</BlogLayout>
